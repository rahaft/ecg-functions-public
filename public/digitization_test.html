<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Digitization Testing - hv-ecg</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .content { padding: 30px; }
        
        .test-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .test-controls h2 { margin-bottom: 15px; }
        .control-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-success:hover { background: #45a049; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .image-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-card:hover { border-color: #667eea; }
        .image-card.selected { border-color: #4CAF50; background: #f0fff4; }
        .image-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .image-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .results-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            display: none;
        }
        .results-panel.show { display: block; }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .metric-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading.show { display: block; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        .error.show { display: block; }
        
        .signal-visualization {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 6px;
        }
        canvas {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ ECG Digitization Testing</h1>
            <p>Select images and test the digitization pipeline</p>
            <div style="margin-top: 15px;">
                <a href="/" style="color: white; text-decoration: underline;">‚Üê Back to Main App</a> |
                <a href="/training_viewer.html" style="color: white; text-decoration: underline;">Training Viewer</a>
            </div>
        </div>
        
        <div class="content">
            <!-- Test Controls -->
            <div class="test-controls">
                <h2>üìã Test Configuration</h2>
                <div class="control-group">
                    <select id="subsetFilter" style="padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
                        <option value="all">All Images</option>
                        <option value="train">Train Only</option>
                        <option value="test">Test Only</option>
                    </select>
                    <input type="number" id="limitInput" placeholder="Limit" value="50" min="1" max="1000"
                           style="padding: 10px; border: 2px solid #ddd; border-radius: 6px; width: 100px;">
                    <button class="btn btn-primary" onclick="loadImages()">üì• Load Images</button>
                    <button class="btn btn-success" onclick="testSelectedImages()" id="testBtn" disabled>
                        üß™ Test Selected (0)
                    </button>
                </div>
                <div id="statusText" style="color: #666; font-size: 0.9em;"></div>
            </div>
            
            <!-- Loading Indicator -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading images...</p>
            </div>
            
            <!-- Error Display -->
            <div class="error" id="error"></div>
            
            <!-- Image Grid -->
            <div class="image-grid" id="imageGrid"></div>
            
            <!-- Results Panel -->
            <div class="results-panel" id="resultsPanel">
                <h2>üìä Test Results</h2>
                <div class="metrics-grid" id="metricsGrid"></div>
                
                <div class="signal-visualization" id="signalViz">
                    <h3>Signal Visualization</h3>
                    <canvas id="signalCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsIWxy1gTV1_e9ZXZnaplcOWqU9PwL_Uc",
            authDomain: "hv-ecg.firebaseapp.com",
            projectId: "hv-ecg",
            storageBucket: "hv-ecg.appspot.com",
            messagingSenderId: "101881880910",
            appId: "1:101881880910:web:2320e56f5dcaaa46febe1f"
        };
        
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        const functions = getFunctions(app);
        
        // GCS image functions
        window.listGCSImages = httpsCallable(functions, 'listGCSImages');
        window.getGCSImageUrl = httpsCallable(functions, 'getGCSImageUrl');
        window.processGCSImage = httpsCallable(functions, 'processGCSImage');
        
        console.log('Firebase initialized for digitization testing');
    </script>

    <script>
        let allImages = [];
        let selectedImages = new Set();
        const signedUrlCache = new Map();
        
        async function loadImages() {
            const subset = document.getElementById('subsetFilter').value;
            const limit = parseInt(document.getElementById('limitInput').value) || 50;
            
            document.getElementById('loading').classList.add('show');
            document.getElementById('error').classList.remove('show');
            document.getElementById('imageGrid').innerHTML = '';
            
            try {
                const result = await window.listGCSImages({ subset, limit });
                
                if (result.data.success && result.data.images) {
                    allImages = result.data.images;
                    displayImages();
                    document.getElementById('statusText').textContent = 
                        `Loaded ${allImages.length} images (${result.data.hasMore ? 'more available' : 'all loaded'})`;
                } else {
                    throw new Error(result.data.message || 'Failed to load images');
                }
            } catch (error) {
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }
        
        async function displayImages() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            for (const img of allImages) {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.dataset.imageId = img.id;
                
                // Get signed URL
                let imageUrl = 'https://via.placeholder.com/300x200?text=Loading...';
                if (signedUrlCache.has(img.id)) {
                    imageUrl = signedUrlCache.get(img.id);
                } else if (img.gcs_bucket && img.gcs_path) {
                    try {
                        const urlResult = await window.getGCSImageUrl({
                            imageId: img.id,
                            gcsBucket: img.gcs_bucket,
                            gcsPath: img.gcs_path
                        });
                        if (urlResult.data.success) {
                            imageUrl = urlResult.data.url;
                            signedUrlCache.set(img.id, imageUrl);
                        }
                    } catch (error) {
                        console.log('Error getting signed URL:', error);
                    }
                }
                
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${img.filename}" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22>ECG Image</text></svg>'">
                    <div class="image-info">
                        <strong>${img.filename}</strong><br>
                        ${img.is_train ? '<span style="color: #4CAF50;">TRAIN</span>' : ''}
                        ${img.is_test ? '<span style="color: #2196F3;">TEST</span>' : ''}
                        ${img.size_formatted ? `<br>Size: ${img.size_formatted}` : ''}
                    </div>
                `;
                
                card.onclick = () => toggleSelection(img.id, card);
                grid.appendChild(card);
            }
        }
        
        function toggleSelection(imageId, cardElement) {
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                cardElement.classList.remove('selected');
            } else {
                selectedImages.add(imageId);
                cardElement.classList.add('selected');
            }
            
            const testBtn = document.getElementById('testBtn');
            const count = selectedImages.size;
            testBtn.disabled = count === 0;
            testBtn.textContent = `üß™ Test Selected (${count})`;
        }
        
        async function testSelectedImages() {
            if (selectedImages.size === 0) return;
            
            document.getElementById('resultsPanel').classList.remove('show');
            document.getElementById('loading').classList.add('show');
            document.getElementById('testBtn').disabled = true;
            
            const imageIds = Array.from(selectedImages);
            const results = [];
            
            try {
                for (let i = 0; i < imageIds.length; i++) {
                    const imageId = imageIds[i];
                    const image = allImages.find(img => img.id === imageId);
                    if (!image) continue;
                    
                    document.getElementById('statusText').textContent = 
                        `Processing ${i + 1}/${imageIds.length}: ${image.filename}...`;
                    
                    try {
                        const result = await window.processGCSImage({
                            imageId: image.id,
                            gcsBucket: image.gcs_bucket,
                            gcsPath: image.gcs_path
                        });
                        
                        if (result.data.success) {
                            results.push({
                                image: image,
                                result: result.data
                            });
                        }
                    } catch (error) {
                        console.error(`Error processing ${image.filename}:`, error);
                    }
                }
                
                displayResults(results);
                
            } catch (error) {
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').classList.add('show');
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('testBtn').disabled = false;
                document.getElementById('statusText').textContent = 
                    `Processed ${results.length}/${imageIds.length} images successfully`;
            }
        }
        
        function displayResults(results) {
            if (results.length === 0) {
                document.getElementById('error').textContent = 'No results to display';
                document.getElementById('error').classList.add('show');
                return;
            }
            
            // Calculate aggregate metrics
            const avgSnr = results.reduce((sum, r) => {
                const snr = r.result.metadata?.quality?.mean_snr || 0;
                return sum + snr;
            }, 0) / results.length;
            
            const totalLeads = results.reduce((sum, r) => {
                return sum + (r.result.leads?.length || 0);
            }, 0);
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Images Processed</div>
                    <div class="metric-value">${results.length}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average SNR</div>
                    <div class="metric-value">${avgSnr.toFixed(2)} dB</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Leads</div>
                    <div class="metric-value">${totalLeads}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Leads per Image</div>
                    <div class="metric-value">${(totalLeads / results.length).toFixed(1)}</div>
                </div>
            `;
            
            // Show first result's signal if available
            if (results[0].result.leads && results[0].result.leads.length > 0) {
                visualizeSignal(results[0].result.leads[0]);
            }
            
            document.getElementById('resultsPanel').classList.add('show');
        }
        
        function visualizeSignal(lead) {
            const canvas = document.getElementById('signalCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;
            
            const values = lead.values || [];
            if (values.length === 0) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw axes
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            const centerY = canvas.height / 2;
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(canvas.width, centerY);
            ctx.stroke();
            
            // Draw signal
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const maxValue = Math.max(...values.map(Math.abs));
            const scale = (canvas.height * 0.4) / (maxValue || 1);
            const stepX = canvas.width / values.length;
            
            values.forEach((value, i) => {
                const x = i * stepX;
                const y = centerY - (value * scale);
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Label
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText(`Lead ${lead.name} - ${values.length} samples`, 10, 20);
        }
        
        // Auto-load images on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadImages();
        });
    </script>
</body>
</html>
