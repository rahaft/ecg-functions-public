<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Image Gallery</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .gallery-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .gallery-item {
            background: var(--card-bg);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .gallery-item-info {
            padding: 1rem;
        }
        
        .gallery-item-info h3 {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            word-break: break-all;
        }
        
        .gallery-item-info p {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .version-footer {
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        .version-info {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .version-info:hover {
            background-color: #e9ecef;
        }
        
        .version-info .separator {
            color: #ccc;
            margin: 0 0.25rem;
        }
        
        .version-copy-btn {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }
        
        .version-copy-btn:hover {
            background: var(--primary-hover);
        }
        
        .version-copy-btn.copied {
            background: var(--success-color);
        }
    </style>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, ref, listAll, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAsIWxy1gTV1_e9ZXZnaplcOWqU9PwL_Uc",
            authDomain: "hv-ecg.firebaseapp.com",
            projectId: "hv-ecg",
            storageBucket: "hv-ecg.appspot.com",
            messagingSenderId: "101881880910",
            appId: "1:101881880910:web:2320e56f5dcaaa46febe1f"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        
        // Auto sign in anonymously
        signInAnonymously(auth).catch(console.error);
        
        // Version info
        const APP_VERSION = '2.3.5';
        const BUILD_TIMESTAMP = '2026.01.22.0055';
        const BUILD_DATE = new Date();
        
        // Python service URL (Cloud Run)
        const PYTHON_SERVICE_URL = 'https://ecg-multi-method-101881880910.us-central1.run.app';
        
        // GCS Configuration
        const GCS_BUCKETS = [
            'ecg-competition-data-1',
            'ecg-competition-data-2',
            'ecg-competition-data-3',
            'ecg-competition-data-4',
            'ecg-competition-data-5'
        ];
        const GCS_PREFIX = 'kaggle-data/physionet-ecg/';
        const MANIFEST_URL = '/gcs_images_manifest.json'; // Hosted on Firebase Hosting
        
        // Global state
        let images = [];
        let allGroups = [];
        let displayedGroups = 0;
        const IMAGES_PER_SET = 9;  // One set = 9 images
        const SETS_PER_LOAD = 1;   // Initial load: 1 set (9 images)
        const SETS_PER_LOAD_MORE = 2; // Load More: 2 sets (18 images)
        
        // Processing state
        let processingGroups = new Set();
        let processedImages = new Map(); // groupKey -> {images: [], subImages: {}}
        
        // Load images from GCS buckets via manifest
        async function loadImages() {
            const galleryGrid = document.getElementById('gallery-grid');
            const loadingEl = document.getElementById('loading');
            
            loadingEl.textContent = 'Loading images from GCS...';
            
            try {
                // Try to load from manifest
                let manifestData = null;
                try {
                    const manifestResponse = await fetch(MANIFEST_URL);
                    if (manifestResponse.ok) {
                        manifestData = await manifestResponse.json();
                        console.log('‚úì Loaded manifest from', MANIFEST_URL);
                    } else {
                        console.warn('Manifest not found, status:', manifestResponse.status);
                    }
                } catch (e) {
                    console.warn('Manifest not available:', e);
                }
                
                images = [];
                
                if (manifestData && manifestData.images) {
                    // Use manifest data - handle both formats
                    images = manifestData.images.map(img => ({
                        name: img.name || img.filename,
                        path: img.path || img.gcs_path,
                        url: img.url || img.gcs_public_url,
                        bucket: img.bucket || img.gcs_bucket,
                        folder: img.folder || '',
                        is_train: img.is_train || false,
                        is_test: img.is_test || false
                    }));
                } else {
                    // No manifest available
                    loadingEl.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                <path d="M9 9h6v6H9z" stroke-width="2"/>
                            </svg>
                            <h2>Manifest not found</h2>
                            <p>Run: <code>python scripts/convert_manifest_for_gallery.py</code></p>
                            <p>Then: <code>copy gcs_images_manifest.json public\gcs_images_manifest.json</code></p>
                            <p>Then: <code>firebase deploy --only hosting</code></p>
                        </div>
                    `;
                    return;
                }
                
                // Group images by prefix (before -) or by folder
                const grouped = {};
                images.forEach(img => {
                    // Try to extract prefix before '-' in filename
                    let groupKey = img.folder || 'other';
                    
                    // If filename has '-', use prefix before it
                    if (img.name && img.name.includes('-')) {
                        groupKey = img.name.split('-')[0];
                    } else if (img.folder) {
                        // Use folder name (test/train) as group
                        groupKey = img.folder;
                    } else {
                        // Fallback: use first part of filename
                        groupKey = img.name ? img.name.split('.')[0] : 'other';
                    }
                    
                    if (!grouped[groupKey]) {
                        grouped[groupKey] = {
                            key: groupKey,
                            images: [],
                            folder: img.folder || '',
                            is_train: img.is_train || false,
                            is_test: img.is_test || false
                        };
                    }
                    grouped[groupKey].images.push(img);
                });
                
                // Render gallery
                if (images.length === 0) {
                    loadingEl.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                <path d="M9 9h6v6H9z" stroke-width="2"/>
                            </svg>
                            <h2>No images found</h2>
                            <p>Images are stored in GCS buckets. Generate manifest to display them.</p>
                        </div>
                    `;
                } else {
                    loadingEl.style.display = 'none';
                    galleryGrid.innerHTML = '';
                    
                    // Sort groups by key
                    const sortedGroups = Object.values(grouped).sort((a, b) => {
                        // Put train first, then test, then others
                        if (a.is_train && !b.is_train) return -1;
                        if (!a.is_train && b.is_train) return 1;
                        if (a.is_test && !b.is_test) return -1;
                        if (!a.is_test && b.is_test) return 1;
                        return a.key.localeCompare(b.key);
                    });
                    
                    // Store groups and render with pagination
                    allGroups = sortedGroups;
                    displayedGroups = 0;
                    renderGroups();
                    
                    console.log(`Loaded ${images.length} images in ${allGroups.length} groups from GCS`);
                }
            } catch (error) {
                console.error('Error loading images:', error);
                loadingEl.textContent = `Error: ${error.message}`;
            }
        }
        
        // Render groups with pagination (by sets of 9 images)
        function renderGroups() {
            const galleryGrid = document.getElementById('gallery-grid');
            let imagesDisplayed = 0;
            const maxImages = displayedGroups === 0 ? 
                (SETS_PER_LOAD * IMAGES_PER_SET) : 
                (SETS_PER_LOAD_MORE * IMAGES_PER_SET);
            
            // Render groups until we hit the image limit
            for (let i = displayedGroups; i < allGroups.length; i++) {
                const group = allGroups[i];
                
                // Check if we've hit image limit
                if (imagesDisplayed + group.images.length > maxImages) {
                    // Show partial group if there's room
                    const remainingImages = maxImages - imagesDisplayed;
                    if (remainingImages > 0) {
                        renderGroup(group, remainingImages);
                        imagesDisplayed += remainingImages;
                    }
                    break;
                }
                
                renderGroup(group);
                imagesDisplayed += group.images.length;
                displayedGroups++;
            }
            
            // Show/hide "Load More" button
            updateLoadMoreButton();
        }
        
        // Render a single group
        function renderGroup(group, maxImages = null) {
            const galleryGrid = document.getElementById('gallery-grid');
            const imagesToShow = maxImages ? group.images.slice(0, maxImages) : group.images;
            
            // Add group header
            const groupHeader = document.createElement('div');
            groupHeader.className = 'gallery-group-header';
            groupHeader.style.gridColumn = '1 / -1';
            groupHeader.style.marginTop = displayedGroups === 0 ? '0' : '2rem';
            groupHeader.style.marginBottom = '1rem';
            groupHeader.style.padding = '0.75rem';
            groupHeader.style.background = 'var(--card-bg)';
            groupHeader.style.borderRadius = '0.5rem';
            groupHeader.style.borderLeft = '4px solid var(--primary-color)';
            
            const groupLabel = group.folder || group.key;
            const groupType = group.is_train ? 'üìö Train' : group.is_test ? 'üß™ Test' : 'üìÅ';
            const isProcessing = processingGroups.has(group.key);
            const isProcessed = processedImages.has(group.key);
            
            groupHeader.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div>
                        <h2 style="margin: 0; font-size: 1.1rem; color: var(--text-primary);">
                            ${groupType} ${groupLabel}
                        </h2>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem; color: var(--text-secondary);">
                            ${imagesToShow.length}${maxImages && imagesToShow.length < group.images.length ? ` of ${group.images.length}` : ''} image(s) in this group
                        </p>
                    </div>
                    <button class="process-group-btn" 
                            data-group-key="${group.key}"
                            onclick="processGroup('${group.key}')"
                            ${isProcessing ? 'disabled' : ''}
                            style="padding: 0.5rem 1rem; background: ${isProcessing ? '#ccc' : 'var(--primary-color)'}; color: white; border: none; border-radius: 0.375rem; cursor: ${isProcessing ? 'not-allowed' : 'pointer'}; font-size: 0.875rem;">
                        ${isProcessing ? '‚è≥ Processing...' : isProcessed ? 'üîÑ Reprocess' : '‚ö° Process'}
                    </button>
                </div>
            `;
            galleryGrid.appendChild(groupHeader);
            
            // Add images in this group
            imagesToShow.forEach(img => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                item.dataset.groupKey = group.key;
                item.dataset.imageName = img.name;
                
                // Check if this is the base image (-0001)
                const isBaseImage = img.name.includes('-0001');
                
                // Get sub-images if processed
                const processed = processedImages.get(group.key);
                const subImages = processed?.subImages?.[img.name] || [];
                
                let subImagesHtml = '';
                if (subImages.length > 0 && !isBaseImage) {
                    subImagesHtml = `
                        <div class="sub-images" style="display: flex; gap: 0.5rem; padding: 0.5rem; background: #f5f5f5; flex-wrap: wrap;">
                            ${subImages.map(sub => `
                                <img src="${sub.url}" alt="${sub.name}" 
                                     style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                     onclick="event.stopPropagation(); window.open('${sub.url}', '_blank')"
                                     title="${sub.name}">
                            `).join('')}
                        </div>
                    `;
                }
                
                item.innerHTML = `
                    <img src="${img.url}" alt="${img.name}" loading="lazy" 
                         onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 24 24\\'%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\'%3EFailed to load%3C/text%3E%3C/svg%3E';">
                    <div class="gallery-item-info">
                        <h3>${img.name}</h3>
                        <p style="font-size: 0.7rem; color: #888;">${img.bucket || 'unknown'}</p>
                        ${isBaseImage ? '<span style="color: green; font-size: 0.7rem;">Base Image</span>' : ''}
                    </div>
                    ${subImagesHtml}
                `;
                item.onclick = () => {
                    if (processed && processed.images.length > 0) {
                        openComparisonModal(group.key, img.name);
                    } else {
                        window.open(img.url, '_blank');
                    }
                };
                galleryGrid.appendChild(item);
            });
        }
        
        // Update "Load More" button visibility and text
        function updateLoadMoreButton() {
            let loadMoreBtn = document.getElementById('load-more-btn');
            
            // If all groups are displayed, remove button
            if (displayedGroups >= allGroups.length) {
                if (loadMoreBtn) {
                    loadMoreBtn.remove();
                }
                return;
            }
            
            // Create button if it doesn't exist
            if (!loadMoreBtn) {
                loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-btn';
                loadMoreBtn.className = 'load-more-btn';
                loadMoreBtn.textContent = 'Load More Images';
                loadMoreBtn.style.cssText = `
                    display: block;
                    margin: 2rem auto;
                    padding: 0.75rem 2rem;
                    font-size: 1rem;
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    transition: background 0.2s;
                `;
                loadMoreBtn.onmouseover = () => loadMoreBtn.style.background = 'var(--primary-hover)';
                loadMoreBtn.onmouseout = () => loadMoreBtn.style.background = 'var(--primary-color)';
                loadMoreBtn.onclick = () => {
                    loadMoreBtn.textContent = 'Loading...';
                    loadMoreBtn.disabled = true;
                    renderGroups();
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Load More Images';
                };
                
                const galleryContainer = document.querySelector('.gallery-container');
                if (galleryContainer) {
                    galleryContainer.appendChild(loadMoreBtn);
                } else {
                    const galleryGrid = document.getElementById('gallery-grid');
                    if (galleryGrid && galleryGrid.parentElement) {
                        galleryGrid.parentElement.appendChild(loadMoreBtn);
                    }
                }
            }
            
            // Update button text with remaining count
            const remaining = allGroups.length - displayedGroups;
            loadMoreBtn.textContent = `Load More (${remaining} group${remaining !== 1 ? 's' : ''} remaining)`;
        }
        
        // Load images on page load (no auth needed for GCS)
        document.addEventListener('DOMContentLoaded', () => {
            loadImages();
        });
        
        // Bulk testing functions
        window.getImageAsBase64 = async function(imgElement) {
            return new Promise((resolve) => {
                if (imgElement.complete) {
                    const canvas = document.createElement('canvas');
                    canvas.width = imgElement.naturalWidth;
                    canvas.height = imgElement.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imgElement, 0, 0);
                    resolve(canvas.toDataURL('image/png').split(',')[1]);
                } else {
                    imgElement.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = imgElement.naturalWidth;
                        canvas.height = imgElement.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(imgElement, 0, 0);
                        resolve(canvas.toDataURL('image/png').split(',')[1]);
                    };
                }
            });
        };
        
        window.detectEdges = async function(imgElement, method = 'canny', crop = false) {
            const base64 = await window.getImageAsBase64(imgElement);
            const response = await fetch(`${PYTHON_SERVICE_URL}/detect-edges`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: base64, method, crop })
            });
            return response.json();
        };
        
        window.processBatch = async function(imageElements, options = {}) {
            const images = await Promise.all(
                Array.from(imageElements).map(img => window.getImageAsBase64(img))
            );
            
            const response = await fetch(`${PYTHON_SERVICE_URL}/process-batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ images, options })
            });
            return response.json();
        };
        
        window.processGCSBatch = async function(imagePaths, bucketName, options = {}) {
            const response = await fetch(`${PYTHON_SERVICE_URL}/process-gcs-batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_paths: imagePaths, bucket: bucketName, options })
            });
            return response.json();
        };
        
        window.bulkTestGallery = async function(options = {}, groupKey = null) {
            const defaultOptions = {
                edge_detection: true,
                color_separation: true,
                grid_detection: true,
                quality_check: true,
                crop_to_content: false,
                color_method: 'lab'
            };
            
            const opts = { ...defaultOptions, ...options };
            
            // Get images - filter by group if specified
            let imageElements = document.querySelectorAll('.gallery-item img');
            
            if (groupKey) {
                // Filter to specific group
                const groupItems = document.querySelectorAll(`.gallery-item[data-group-key="${groupKey}"] img`);
                imageElements = groupItems;
            }
            
            if (imageElements.length === 0) {
                console.warn('No valid images found in gallery' + (groupKey ? ` for group: ${groupKey}` : ''));
                return { success: false, error: 'No images found' };
            }
            
            // Process up to 10 images in parallel
            const images = Array.from(imageElements).slice(0, 10);
            console.log(`Processing ${images.length} images${groupKey ? ` from group: ${groupKey}` : ''}...`);
            
            return window.processBatch(images, opts);
        };
        
        // Test specific group by key
        window.testGroup = async function(groupKey, options = {}) {
            return window.bulkTestGallery(options, groupKey);
        };
        
        window.quickBulkTest = function() {
            return window.bulkTestGallery();
        };
        
        // Copy version info function
        window.copyVersionInfo = function() {
            const versionEl = document.getElementById('app-version');
            const buildEl = document.getElementById('app-build-timestamp');
            const dateEl = document.getElementById('app-build-date');
            const sdkEl = document.getElementById('app-firebase-sdk');
            
            const version = versionEl ? versionEl.textContent : APP_VERSION;
            const build = buildEl ? buildEl.textContent : BUILD_TIMESTAMP;
            const deployed = dateEl ? dateEl.textContent : BUILD_DATE.toLocaleString();
            const firebaseSDK = sdkEl ? sdkEl.textContent : '10.7.1';
            
            const text = `Version: ${version} | Build: ${build} | Deployed: ${deployed} | Firebase SDK: ${firebaseSDK}`;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('version-copy-btn');
                const container = document.getElementById('version-info-container');
                
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }
                
                if (container) {
                    container.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        container.style.backgroundColor = '';
                    }, 500);
                }
                
                console.log('‚úì Version info copied:', text);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        };
        
        // Update version info on load
        document.addEventListener('DOMContentLoaded', () => {
            const versionEl = document.getElementById('app-version');
            const buildEl = document.getElementById('app-build-timestamp');
            const dateEl = document.getElementById('app-build-date');
            
            if (versionEl) versionEl.textContent = APP_VERSION;
            if (buildEl) buildEl.textContent = BUILD_TIMESTAMP;
            if (dateEl) dateEl.textContent = BUILD_DATE.toLocaleString();
        });
        
        // Process group of images
        window.processGroup = async function(groupKey) {
            const group = allGroups.find(g => g.key === groupKey);
            if (!group) {
                console.error('Group not found:', groupKey);
                return;
            }
            
            // Mark as processing
            processingGroups.add(groupKey);
            updateProcessButton(groupKey, true);
            
            try {
                // Get image paths from group
                const imagePaths = group.images.map(img => img.path || img.name);
                const bucketName = group.images[0]?.bucket || GCS_BUCKETS[0];
                
                console.log(`Processing group ${groupKey} with ${imagePaths.length} images`);
                
                // Call process-gcs-batch endpoint
                const response = await window.processGCSBatch(imagePaths, bucketName, {
                    edge_detection: true,
                    color_separation: true,
                    grid_detection: true,
                    quality_check: true,
                    crop_to_content: false,
                    color_method: 'lab'
                });
                
                if (response.success) {
                    // Store processed results
                    processedImages.set(groupKey, {
                        images: response.results || [],
                        subImages: {}
                    });
                    
                    // Update UI
                    updateProcessButton(groupKey, false, true);
                    console.log(`‚úì Processed group ${groupKey}`);
                } else {
                    throw new Error(response.error || 'Processing failed');
                }
            } catch (error) {
                console.error('Error processing group:', error);
                alert(`Failed to process group: ${error.message}`);
                updateProcessButton(groupKey, false, false);
            } finally {
                processingGroups.delete(groupKey);
            }
        };
        
        // Update process button state
        function updateProcessButton(groupKey, isProcessing, isProcessed = false) {
            const btn = document.querySelector(`.process-group-btn[data-group-key="${groupKey}"]`);
            if (btn) {
                btn.disabled = isProcessing;
                btn.textContent = isProcessing ? '‚è≥ Processing...' : (isProcessed ? 'üîÑ Reprocess' : '‚ö° Process');
                btn.style.background = isProcessing ? '#ccc' : 'var(--primary-color)';
            }
        }
        
        // Comparison modal state
        let currentComparisonGroup = null;
        let currentComparisonImages = [];
        let currentComparisonIndex = 0;
        let currentComparisonMetrics = {};
        
        // Open comparison modal
        window.openComparisonModal = function(groupKey, imageName) {
            const processed = processedImages.get(groupKey);
            if (!processed || !processed.images || processed.images.length === 0) {
                alert('No processed images available. Please process the group first.');
                return;
            }
            
            currentComparisonGroup = groupKey;
            currentComparisonImages = processed.images;
            currentComparisonIndex = 0;
            
            const modal = document.getElementById('comparison-modal');
            modal.style.display = 'block';
            
            // Find image index
            const imageIndex = currentComparisonImages.findIndex(img => 
                img.name === imageName || img.original_name === imageName
            );
            if (imageIndex >= 0) {
                currentComparisonIndex = imageIndex;
            }
            
            renderComparison();
        };
        
        // Close comparison modal
        window.closeComparisonModal = function() {
            const modal = document.getElementById('comparison-modal');
            modal.style.display = 'none';
            currentComparisonGroup = null;
            currentComparisonImages = [];
            currentComparisonIndex = 0;
        };
        
        // Navigate images in comparison modal
        window.navigateImage = function(direction) {
            if (currentComparisonImages.length === 0) return;
            
            currentComparisonIndex += direction;
            if (currentComparisonIndex < 0) {
                currentComparisonIndex = currentComparisonImages.length - 1;
            } else if (currentComparisonIndex >= currentComparisonImages.length) {
                currentComparisonIndex = 0;
            }
            
            renderComparison();
        };
        
        // Render comparison view
        function renderComparison() {
            if (currentComparisonImages.length === 0) return;
            
            const current = currentComparisonImages[currentComparisonIndex];
            
            // Update images
            const originalImg = document.getElementById('comparison-original');
            const processedImg = document.getElementById('comparison-processed');
            const originalName = document.getElementById('comparison-original-name');
            const processedName = document.getElementById('comparison-processed-name');
            
            if (originalImg && current.original_url) {
                originalImg.src = current.original_url;
            }
            if (processedImg && current.processed_url) {
                processedImg.src = current.processed_url;
            }
            if (originalName) {
                originalName.textContent = current.original_name || current.name || 'Original';
            }
            if (processedName) {
                processedName.textContent = current.processed_name || current.name || 'Processed';
            }
            
            // Update metrics
            if (current.metrics) {
                const snrEl = document.getElementById('metric-snr');
                const typeEl = document.getElementById('metric-type');
                const contrastEl = document.getElementById('metric-contrast');
                const smudgesEl = document.getElementById('metric-smudges');
                
                if (snrEl && current.metrics.snr_db !== undefined) {
                    snrEl.textContent = current.metrics.snr_db.toFixed(2);
                }
                if (typeEl && current.metrics.image_type) {
                    typeEl.textContent = current.metrics.image_type;
                }
                if (contrastEl && current.metrics.contrast !== undefined) {
                    contrastEl.textContent = current.metrics.contrast.toFixed(2);
                }
                if (smudgesEl && current.metrics.smudges) {
                    smudgesEl.textContent = current.metrics.smudges.qualitative || 
                                          `${current.metrics.smudges.smudge_count} smudges`;
                }
            }
            
            // Update thumbnails
            renderThumbnails();
        }
        
        // Render thumbnail strip
        function renderThumbnails() {
            const strip = document.getElementById('thumbnail-strip');
            if (!strip) return;
            
            strip.innerHTML = currentComparisonImages.map((img, index) => {
                const isActive = index === currentComparisonIndex;
                const thumbUrl = img.thumbnail_url || img.processed_url || img.original_url || img.url;
                return `
                    <div class="thumbnail-item ${isActive ? 'active' : ''}" 
                         onclick="navigateToImage(${index})">
                        <img src="${thumbUrl}" alt="${img.name}">
                    </div>
                `;
            }).join('');
        }
        
        // Navigate to specific image
        window.navigateToImage = function(index) {
            if (index >= 0 && index < currentComparisonImages.length) {
                currentComparisonIndex = index;
                renderComparison();
            }
        };
        
        // Update overlays
        window.updateOverlays = function() {
            const showEdges = document.getElementById('toggle-edges')?.checked || false;
            const showSmudges = document.getElementById('toggle-smudges')?.checked || false;
            const showGrid = document.getElementById('toggle-grid')?.checked || false;
            
            // TODO: Implement overlay rendering on images
            console.log('Overlays:', { showEdges, showSmudges, showGrid });
        };
        
        // Choose random group
        window.chooseRandomGroup = function() {
            if (allGroups.length === 0) {
                alert('No groups available');
                return;
            }
            
            const randomIndex = Math.floor(Math.random() * allGroups.length);
            const randomGroup = allGroups[randomIndex];
            
            // Scroll to group
            const groupHeader = document.querySelector(`.gallery-group-header`);
            if (groupHeader) {
                groupHeader.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            // Highlight it briefly
            const btn = document.querySelector(`.process-group-btn[data-group-key="${randomGroup.key}"]`);
            if (btn) {
                btn.style.background = '#ff6b6b';
                setTimeout(() => {
                    btn.style.background = 'var(--primary-color)';
                }, 2000);
            }
            
            console.log('Selected random group:', randomGroup.key);
        };
    </script>
    
    <!-- WebSocket Client (optional, for future use) -->
    <script src="websocket_client.js"></script>
</head>
<body>
    <div class="gallery-container">
        <header>
            <h1>ECG Image Gallery</h1>
            <div style="margin-top: 10px; display: flex; gap: 1rem; align-items: center;">
                <a href="/index.html" style="color: var(--primary-color); text-decoration: underline;">‚Üê Back to Upload</a>
                <button id="choose-random-btn" onclick="chooseRandomGroup()" 
                        style="padding: 0.5rem 1rem; background: #6c757d; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem;">
                    üé≤ Choose Random Set
                </button>
            </div>
        </header>
        
        <main>
            <div id="loading" class="loading">Loading images...</div>
            <div id="gallery-grid" class="gallery-grid"></div>
        </main>
        
        <footer class="version-footer">
            <div class="version-info" id="version-info-container" onclick="copyVersionInfo()" title="Click to copy version info">
                <span>Version: <span id="app-version">Loading...</span></span>
                <span class="separator">|</span>
                <span>Build: <span id="app-build-timestamp">Loading...</span></span>
                <span class="separator">|</span>
                <span>Deployed: <span id="app-build-date">Loading...</span></span>
                <span class="separator">|</span>
                <span>Firebase SDK: <span id="app-firebase-sdk">10.7.1</span></span>
            </div>
            <button class="version-copy-btn" id="version-copy-btn" onclick="copyVersionInfo()">üìã Copy</button>
        </footer>
    </div>
    
    <!-- Comparison Modal -->
    <div id="comparison-modal" class="comparison-modal" style="display: none;">
        <div class="comparison-modal-content">
            <div class="comparison-header">
                <h2 id="comparison-title">Image Comparison</h2>
                <button class="modal-close" onclick="closeComparisonModal()">&times;</button>
            </div>
            
            <!-- Thumbnail Strip -->
            <div class="thumbnail-strip" id="thumbnail-strip"></div>
            
            <!-- Main Comparison Area -->
            <div class="comparison-main">
                <!-- Navigation Arrows -->
                <button class="nav-arrow nav-left" onclick="navigateImage(-1)">‚Üê</button>
                <button class="nav-arrow nav-right" onclick="navigateImage(1)">‚Üí</button>
                
                <!-- Image Display -->
                <div class="comparison-images">
                    <div class="image-panel">
                        <h3>Original</h3>
                        <img id="comparison-original" src="" alt="Original">
                        <p id="comparison-original-name" class="image-name"></p>
                    </div>
                    <div class="image-panel">
                        <h3>Processed</h3>
                        <img id="comparison-processed" src="" alt="Processed">
                        <p id="comparison-processed-name" class="image-name"></p>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Panel -->
            <div class="metrics-panel">
                <h3>Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <label>SNR:</label>
                        <span id="metric-snr">--</span> dB
                    </div>
                    <div class="metric-item">
                        <label>Image Type:</label>
                        <span id="metric-type">--</span>
                    </div>
                    <div class="metric-item">
                        <label>Contrast:</label>
                        <span id="metric-contrast">--</span>
                    </div>
                    <div class="metric-item">
                        <label>Smudges:</label>
                        <span id="metric-smudges">--</span>
                    </div>
                </div>
                
                <!-- Toggle Overlays -->
                <div class="overlay-toggles">
                    <label><input type="checkbox" id="toggle-edges" onchange="updateOverlays()"> Show Edges</label>
                    <label><input type="checkbox" id="toggle-smudges" onchange="updateOverlays()"> Show Smudges</label>
                    <label><input type="checkbox" id="toggle-grid" onchange="updateOverlays()"> Show Grid</label>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        .comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .comparison-modal-content {
            max-width: 1400px;
            margin: 2rem auto;
            background: white;
            border-radius: 0.5rem;
            padding: 2rem;
            position: relative;
        }
        
        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }
        
        .thumbnail-strip {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .thumbnail-item {
            min-width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
        }
        
        .thumbnail-item.active {
            border-color: var(--primary-color);
        }
        
        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .comparison-main {
            position: relative;
            margin-bottom: 2rem;
        }
        
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }
        
        .nav-left {
            left: -25px;
        }
        
        .nav-right {
            right: -25px;
        }
        
        .comparison-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .image-panel {
            text-align: center;
        }
        
        .image-panel img {
            max-width: 100%;
            max-height: 500px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        
        .image-name {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #666;
        }
        
        .metrics-panel {
            border-top: 1px solid #ddd;
            padding-top: 1.5rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-item {
            padding: 0.75rem;
            background: #f5f5f5;
            border-radius: 0.375rem;
        }
        
        .overlay-toggles {
            display: flex;
            gap: 1.5rem;
        }
        
        .overlay-toggles label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
    </style>
</body>
</html>
