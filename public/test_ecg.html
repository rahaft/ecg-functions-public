<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Digitization Test - Try It Now</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .test-header p {
            color: #666;
            font-size: 1.1em;
        }
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f0f0;
        }
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8e8f0;
        }
        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .file-input {
            display: none;
        }
        .btn-process {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .btn-process:hover {
            transform: translateY(-2px);
        }
        .btn-process:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .progress-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .results-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .results-header h2 {
            color: #667eea;
            margin: 0;
        }
        .signal-chart {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .signal-chart canvas {
            width: 100%;
            height: 200px;
        }
        .lead-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .lead-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .lead-card h3 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        .btn-download {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }
    </style>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAsIWxy1gTV1_e9ZXZnaplcOWqU9PwL_Uc",
            authDomain: "hv-ecg.firebaseapp.com",
            projectId: "hv-ecg",
            storageBucket: "hv-ecg.appspot.com",
            messagingSenderId: "101881880910",
            appId: "1:101881880910:web:2320e56f5dcaaa46febe1f"
        };
        
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        window.functions = getFunctions(app);
    </script>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ðŸ§ª ECG Digitization Test</h1>
            <p>Upload an ECG image to see it digitized in real-time</p>
        </div>

        <div class="upload-section">
            <h2>Upload ECG Image</h2>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">ðŸ“¤</div>
                <p><strong>Drag and drop your ECG image here</strong></p>
                <p>or click to select a file</p>
                <p style="color: #666; font-size: 0.9em; margin-top: 10px;">Supports PNG, JPEG, TIFF formats</p>
                <input type="file" id="file-input" class="file-input" accept="image/*">
            </div>
            <div style="text-align: center;">
                <button class="btn-process" id="process-btn" disabled>Process ECG Image</button>
            </div>
            <div class="error-message" id="error-message"></div>
        </div>

        <div class="progress-section" id="progress-section">
            <h2>Processing...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill">0%</div>
            </div>
            <p id="progress-text">Initializing...</p>
        </div>

        <div class="results-section" id="results-section">
            <div class="results-header">
                <h2>Results</h2>
                <button class="btn-download" id="download-btn">Download Results (JSON)</button>
            </div>
            
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-label">Mean SNR</div>
                    <div class="metric-value" id="mean-snr">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Leads Processed</div>
                    <div class="metric-value" id="leads-count">-</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Sampling Rate</div>
                    <div class="metric-value" id="sampling-rate">-</div>
                </div>
            </div>

            <div class="lead-grid" id="lead-grid">
                <!-- Lead cards will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const processBtn = document.getElementById('process-btn');
        const progressSection = document.getElementById('progress-section');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultsSection = document.getElementById('results-section');
        const errorMessage = document.getElementById('error-message');
        const leadGrid = document.getElementById('lead-grid');
        const downloadBtn = document.getElementById('download-btn');

        let selectedFile = null;
        let processingResult = null;

        // Upload area click
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }
            selectedFile = file;
            uploadArea.innerHTML = `
                <div class="upload-icon">âœ…</div>
                <p><strong>${file.name}</strong></p>
                <p style="color: #666; font-size: 0.9em;">Click to select a different file</p>
            `;
            processBtn.disabled = false;
            hideError();
        }

        // Process button
        processBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            // Show progress
            progressSection.style.display = 'block';
            resultsSection.style.display = 'none';
            processBtn.disabled = true;
            updateProgress(10, 'Reading image...');

            try {
                // Read file as base64
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        updateProgress(20, 'Uploading to server...');
                        
                        // Create a temporary record in Firestore
                        const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        const { signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
                        
                        // Sign in anonymously if needed
                        try {
                            await signInAnonymously(window.auth);
                        } catch (err) {
                            console.log('Already signed in or sign-in failed:', err);
                        }

                        updateProgress(30, 'Processing image...');

                        // For now, we'll use a simplified approach
                        // In production, you'd call the Cloud Function
                        // This is a placeholder that shows the structure
                        await simulateProcessing();

                    } catch (error) {
                        console.error('Processing error:', error);
                        showError('Failed to process image: ' + error.message);
                        progressSection.style.display = 'none';
                        processBtn.disabled = false;
                    }
                };
                reader.readAsDataURL(selectedFile);
            } catch (error) {
                showError('Failed to read file: ' + error.message);
                progressSection.style.display = 'none';
                processBtn.disabled = false;
            }
        });

        async function simulateProcessing() {
            // Simulate processing steps
            const steps = [
                { progress: 40, text: 'Preprocessing image...' },
                { progress: 50, text: 'Detecting grid...' },
                { progress: 60, text: 'Extracting leads...' },
                { progress: 70, text: 'Extracting signals...' },
                { progress: 80, text: 'Post-processing...' },
                { progress: 90, text: 'Calculating metrics...' },
                { progress: 100, text: 'Complete!' }
            ];

            for (const step of steps) {
                await new Promise(resolve => setTimeout(resolve, 500));
                updateProgress(step.progress, step.text);
            }

            // For demo, show sample results
            // In production, this would come from the actual processing
            showResults({
                leads: [
                    { name: 'I', values: Array(1000).fill(0).map(() => Math.random() * 2 - 1) },
                    { name: 'II', values: Array(1000).fill(0).map(() => Math.random() * 2 - 1) },
                    { name: 'III', values: Array(1000).fill(0).map(() => Math.random() * 2 - 1) },
                ],
                metadata: {
                    sampling_rate: 500,
                    quality: {
                        mean_snr: 15.5,
                        min_snr: 12.3
                    }
                }
            });
        }

        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressFill.textContent = percent + '%';
            progressText.textContent = text;
        }

        function showResults(result) {
            processingResult = result;
            progressSection.style.display = 'none';
            resultsSection.style.display = 'block';

            // Update metrics
            document.getElementById('mean-snr').textContent = 
                result.metadata?.quality?.mean_snr?.toFixed(1) + ' dB' || 'N/A';
            document.getElementById('leads-count').textContent = result.leads?.length || 0;
            document.getElementById('sampling-rate').textContent = 
                result.metadata?.sampling_rate || 'N/A';

            // Show leads
            leadGrid.innerHTML = '';
            if (result.leads && result.leads.length > 0) {
                result.leads.forEach(lead => {
                    const card = document.createElement('div');
                    card.className = 'lead-card';
                    card.innerHTML = `
                        <h3>Lead ${lead.name}</h3>
                        <p>Duration: ${(lead.values.length / (result.metadata?.sampling_rate || 500)).toFixed(2)}s</p>
                        <p>Samples: ${lead.values.length}</p>
                        <canvas id="chart-${lead.name}" width="400" height="100"></canvas>
                    `;
                    leadGrid.appendChild(card);

                    // Draw simple chart
                    setTimeout(() => {
                        drawChart(`chart-${lead.name}`, lead.values);
                    }, 100);
                });
            }
        }

        function drawChart(canvasId, values) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const max = Math.max(...values.map(Math.abs));
            const scale = height / (max * 2.5);

            values.forEach((val, i) => {
                const x = (i / values.length) * width;
                const y = height / 2 - val * scale;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (!processingResult) return;
            const dataStr = JSON.stringify(processingResult, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ecg_results.json';
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
