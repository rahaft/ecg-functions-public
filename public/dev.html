<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Development Page - ECG Processing</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Dev Page Specific Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .dev-top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            box-shadow: var(--shadow);
            height: 60px;
            box-sizing: border-box;
        }

        .dev-top-nav-left { display: flex; align-items: center; gap: 1rem; }
        .dev-top-nav-right { display: flex; align-items: center; gap: 1.5rem; }

        .dev-title { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin: 0; }

        .project-selector { display: flex; align-items: center; gap: 0.5rem; }
        .project-selector label { font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); }
        .project-selector select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            min-width: 200px;
        }
        .project-selector select:hover { border-color: var(--primary-color); }
        .project-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .storage-checkbox { display: flex; align-items: center; gap: 0.5rem; }
        .storage-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .storage-checkbox label { font-size: 0.875rem; color: var(--text-primary); cursor: pointer; user-select: none; }

        .dev-container { display: flex; height: calc(100vh - 60px); overflow: hidden; }

        .dev-sidebar {
            width: 300px;
            min-width: 48px;
            background: var(--card-bg);
            border-right: 2px solid var(--border-color);
            overflow: hidden;
            font-family: 'Times New Roman', Times, serif;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
            transition: width 0.25s ease;
        }
        .dev-sidebar.collapsed {
            width: 48px;
        }
        .dev-sidebar.collapsed .sidebar-header-text,
        .dev-sidebar.collapsed .image-groups-list {
            display: none !important;
        }
        .dev-sidebar.collapsed .sidebar-header {
            justify-content: center;
            padding: 0.5rem;
        }
        .dev-sidebar.collapsed .sidebar-collapse-btn {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 1rem;
            background: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .sidebar-header-text { white-space: nowrap; overflow: hidden; }

        .sidebar-collapse-btn {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: var(--card-bg);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background 0.2s, color 0.2s;
        }
        .sidebar-collapse-btn:hover {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .image-groups-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; min-height: 0; }
        .image-group-item { border-bottom: 1px solid var(--border-color); }
        .image-group-header {
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
            user-select: none;
        }
        .image-group-header:hover { background-color: var(--bg-color); }
        .image-group-header.expanded { background-color: rgba(37, 99, 235, 0.1); font-weight: bold; }
        .group-prefix { font-family: 'Times New Roman', Times, serif; font-size: 1rem; }
        .group-count { font-size: 0.875rem; color: var(--text-secondary); }
        .group-expand-icon { font-size: 0.75rem; color: var(--text-secondary); transition: transform 0.2s; }
        .image-group-header.expanded .group-expand-icon { transform: rotate(90deg); }

        .image-group-content { display: none; background: var(--bg-color); }
        .image-group-content.expanded { display: block; }
        .group-select-all {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
        }
        .group-select-all input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .group-select-all label { font-size: 0.875rem; color: var(--text-secondary); cursor: pointer; user-select: none; }
        .group-images { padding: 0.5rem 0; }
        .group-image-item {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .group-image-item:hover { background-color: rgba(37, 99, 235, 0.05); }
        .group-image-item.selected { background-color: rgba(37, 99, 235, 0.1); }
        .group-image-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .group-image-thumbnail { width: 40px; height: 40px; object-fit: cover; border-radius: 0.25rem; border: 1px solid var(--border-color); }
        .group-image-name { flex: 1; font-size: 0.875rem; color: var(--text-primary); font-family: 'Times New Roman', Times, serif; word-break: break-all; }

        .dev-main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg-color); }

        .dev-control-panel {
            padding: 1rem 2rem;
            background: var(--card-bg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: nowrap;
        }

        .dev-control-panel .control-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: nowrap;
        }

        .run-all-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .run-all-btn:hover:not(:disabled) { background: var(--primary-hover); }
        .run-all-btn:disabled { background: var(--secondary-color); cursor: not-allowed; opacity: 0.6; }

        .stage-buttons { display: flex; gap: 0.5rem; flex-wrap: nowrap; }
        .stage-btn {
            padding: 0.5rem 1rem;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .stage-btn:hover:not(:disabled) { background: #5a6268; }
        .stage-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .dev-content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .dev-images-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            flex-shrink: 0;
        }
        @media (max-width: 900px) { .dev-images-row { grid-template-columns: 1fr; } }

        .content-section {
            background: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        .content-section h3 { margin-top: 0; margin-bottom: 1rem; color: var(--text-primary); font-size: 1.1rem; }
        .image-display { width: 100%; max-width: 100%; height: auto; border: 1px solid var(--border-color); border-radius: 0.5rem; background: var(--bg-color); }
        .vector-display {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            background: var(--bg-color);
            padding: 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .steps-accordion-section {
            flex: 1;
            min-height: 280px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .step-accordion {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--card-bg);
            overflow: hidden;
        }
        .step-accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            cursor: pointer;
            background: var(--bg-color);
            transition: background 0.2s;
            user-select: none;
        }
        .step-accordion-header:hover { background: rgba(37, 99, 235, 0.06); }
        .step-title-wrap { display: flex; align-items: center; gap: 0.5rem; }
        .step-expand-icon { font-size: 0.875rem; color: var(--text-secondary); transition: transform 0.2s; }
        .step-accordion.expanded .step-expand-icon { transform: rotate(90deg); }
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }
        .step-group-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary-color);
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .step-settings { display: flex; align-items: center; gap: 1rem; margin-left: auto; flex-wrap: wrap; }
        .step-setting-checkbox {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        .step-setting-checkbox input { width: 16px; height: 16px; cursor: pointer; }

        .step-accordion-actions { display: flex; align-items: center; gap: 0.5rem; }

        .step-accordion-body { display: none; padding: 1rem; border-top: 1px solid var(--border-color); background: var(--card-bg); }
        .step-accordion.expanded .step-accordion-body { display: block; }

        .step-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 900px) { .step-detail-grid { grid-template-columns: 1fr; } }

        .step-detail-block {
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.75rem;
            background: var(--bg-color);
        }
        .step-detail-block h4 { margin: 0 0 0.5rem 0; font-size: 0.875rem; color: var(--text-secondary); }
        .step-detail-block .vector-display { font-size: 0.75rem; padding: 0.5rem; max-height: 140px; overflow-y: auto; }
        .step-detail-block .step-output-img { width: 100%; max-height: 100%; object-fit: contain; border-radius: 0.25rem; background: var(--card-bg); }

        .step-output-image-block { grid-column: 1 / -1; margin-top: 0.5rem; }
        .step-output-image-block .step-output-image-wrap {
            width: 100%;
            max-height: 320px;
            min-height: 120px;
            border: 2px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.5rem;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }
        .step-output-image-wrap img { max-width: 100%; max-height: 300px; object-fit: contain; }
        .step-output-image-placeholder { padding: 2rem; font-size: 0.875rem; color: var(--text-secondary); }

        .settings-btn {
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin-left: auto;
            flex-shrink: 0;
            color: var(--text-primary);
        }
        .settings-btn:hover { border-color: var(--primary-color); background: rgba(37, 99, 235, 0.06); }

        .settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .settings-modal.open { display: flex; }
        .settings-modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
        }
        .settings-modal-content {
            position: relative;
            background: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }
        .settings-modal-content h3 { margin: 0 0 1rem 0; color: var(--text-primary); }
        .settings-modal-content h4 { margin: 1rem 0 0.5rem 0; font-size: 0.875rem; color: var(--text-secondary); }
        .settings-modal-close {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .stage-group-checkbox { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer; transition: background 0.2s; }
        .stage-group-checkbox:hover { background: rgba(37, 99, 235, 0.05); }
        .stage-group-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .stage-group-checkbox label { font-size: 0.875rem; color: var(--text-primary); cursor: pointer; user-select: none; }

        .dev-bottom-bar {
            padding: 1rem 2rem;
            background: var(--card-bg);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .save-results-btn {
            padding: 0.75rem 2rem;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .save-results-btn:hover:not(:disabled) { background: #059669; }
        .save-results-btn:disabled { background: var(--secondary-color); cursor: not-allowed; opacity: 0.6; }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        const firebaseConfig = {
            apiKey: "AIzaSyAsIWxy1gTV1_e9ZXZnaplcOWqU9PwL_Uc",
            authDomain: "hv-ecg.firebaseapp.com",
            projectId: "hv-ecg",
            storageBucket: "hv-ecg.appspot.com",
            messagingSenderId: "101881880910",
            appId: "1:101881880910:web:2320e56f5dcaaa46febe1f"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        signInAnonymously(auth).catch(console.error);

        const PYTHON_SERVICE_URL = 'https://ecg-multi-method-101881880910.us-central1.run.app';

        const PROJECT_CONFIG = {
            ecg: {
                name: 'ECG Image Processing',
                gcs_buckets: ['ecg-competition-data-1','ecg-competition-data-2','ecg-competition-data-3','ecg-competition-data-4','ecg-competition-data-5'],
                gcs_prefix: 'kaggle-data/physionet-ecg/',
                manifest_url: '/gcs_images_manifest.json',
                grouping_method: 'prefix',
                stages: [
                    { id: 1, name: 'Quality Gates', suffix: 's01', group: 'preprocessing' },
                    { id: 2, name: 'Color Separation', suffix: 's02', group: 'preprocessing' },
                    { id: 3, name: 'Grid Detection', suffix: 's03', group: 'detection' },
                    { id: 4, name: 'Edge Detection', suffix: 's04', group: 'detection' },
                    { id: 5, name: 'Signal Extraction', suffix: 's05', group: 'extraction' }
                ],
                stageGroups: {
                    preprocessing: { name: 'Preprocessing', stages: [1, 2] },
                    detection: { name: 'Detection', stages: [3, 4] },
                    extraction: { name: 'Extraction', stages: [5] }
                }
            },
            isci: {
                name: 'ISCI (ISIC Melanoma Classification)',
                gcs_buckets: ['hv-ecg.appspot.com'],
                gcs_prefix: 'melanoma_isic/',
                manifest_url: '/isic_images_manifest.json',
                grouping_method: 'folder',
                stages: [
                    { id: 1, name: 'Image Preprocessing', suffix: 's01', group: 'preprocessing' },
                    { id: 2, name: 'Segmentation', suffix: 's02', group: 'segmentation' },
                    { id: 3, name: 'Feature Extraction', suffix: 's03', group: 'analysis' },
                    { id: 4, name: 'ABCDE Analysis', suffix: 's04', group: 'analysis' },
                    { id: 5, name: 'Classification', suffix: 's05', group: 'classification' }
                ],
                stageGroups: {
                    preprocessing: { name: 'Preprocessing', stages: [1] },
                    segmentation: { name: 'Segmentation', stages: [2] },
                    analysis: { name: 'Analysis', stages: [3, 4] },
                    classification: { name: 'Classification', stages: [5] }
                }
            }
        };

        let currentProject = 'ecg';
        let usePermanentStorage = false;
        let imageGroups = [];
        let selectedImages = new Set();
        let expandedGroups = new Set();
        let selectedStageGroups = new Set();
        let stageIncludeInRunAll = {};
        let stageOverlayLabel = {};

        window.PROJECT_CONFIG = PROJECT_CONFIG;
        window.getCurrentProject = () => currentProject;
        window.setCurrentProject = (p) => { currentProject = p; };
        window.getUsePermanentStorage = () => usePermanentStorage;
        window.setUsePermanentStorage = (v) => { usePermanentStorage = v; };
        window.getSelectedImages = () => selectedImages;
        window.getStageIncludeInRunAll = (id) => stageIncludeInRunAll[id] !== false;
        window.getStageOverlayLabel = (id) => !!stageOverlayLabel[id];
        window.setStageIncludeInRunAll = (id, v) => { stageIncludeInRunAll[id] = v; };
        window.setStageOverlayLabel = (id, v) => { stageOverlayLabel[id] = v; };
    </script>
</head>
<body>
    <div class="dev-top-nav">
        <div class="dev-top-nav-left">
            <h1 class="dev-title">üîß Development Page</h1>
        </div>
        <div class="dev-top-nav-right">
            <div class="project-selector">
                <label for="project-select">Project:</label>
                <select id="project-select" onchange="handleProjectChange(this.value)">
                    <option value="ecg" selected>ECG Image Processing</option>
                    <option value="isci">ISCI</option>
                </select>
            </div>
            <div class="storage-checkbox">
                <input type="checkbox" id="use-permanent-storage" onchange="handleStorageChange(this.checked)">
                <label for="use-permanent-storage">Save to permanent storage (not temp)</label>
            </div>
        </div>
    </div>

    <div class="dev-container">
        <div class="dev-sidebar" id="dev-sidebar">
            <div class="sidebar-header">
                <span class="sidebar-header-text">Image Groups</span>
                <button type="button" class="sidebar-collapse-btn" id="sidebar-collapse-btn" onclick="toggleSidebar()" title="Collapse sidebar" aria-label="Collapse sidebar">‚óÄ</button>
            </div>
            <ul class="image-groups-list" id="image-groups-list">
                <li class="empty-state" style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                    <div class="empty-state-icon">üìÅ</div>
                    <div>Loading image groups...</div>
                </li>
            </ul>
        </div>

        <div class="dev-main-content">
            <div class="dev-control-panel">
                <div class="control-row">
                    <button class="run-all-btn" id="run-all-btn" onclick="runAllStages()" disabled>‚ñ∂ Run All</button>
                    <div class="stage-buttons" id="stage-buttons"></div>
                </div>
                <button type="button" class="settings-btn" id="settings-btn" onclick="openSettingsModal()">‚öôÔ∏è Settings</button>
            </div>

            <div class="dev-content-area">
                <div class="dev-images-row">
                    <div class="content-section">
                        <h3>Input Image</h3>
                        <div id="input-image-container">
                            <div class="empty-state">
                                <div class="empty-state-icon">üñºÔ∏è</div>
                                <div>No image selected</div>
                                <div style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);">Select an image from the sidebar to begin</div>
                            </div>
                        </div>
                    </div>
                    <div class="content-section">
                        <h3>Output Image</h3>
                        <div id="output-image-container">
                            <div class="empty-state">
                                <div class="empty-state-icon">‚öôÔ∏è</div>
                                <div>No processing results</div>
                                <div style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);">Run a stage to see output</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section steps-accordion-section">
                    <h3>Processing Steps</h3>
                    <div id="steps-accordion-container"></div>
                </div>
            </div>

            <div class="dev-bottom-bar">
                <button class="save-results-btn" id="save-results-btn" onclick="saveResults()" disabled>üíæ Save Results</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="settings-modal">
        <div class="settings-modal-backdrop" onclick="closeSettingsModal()"></div>
        <div class="settings-modal-content">
            <h3>Settings</h3>
            <div class="settings-section" id="settings-stage-groups">
                <h4>Stage Groups</h4>
                <div id="stage-groups-list"></div>
            </div>
            <button type="button" class="settings-modal-close" onclick="closeSettingsModal()">Close</button>
        </div>
    </div>

    <script>
        function getConfig() {
            const proj = typeof window.getCurrentProject === 'function' ? window.getCurrentProject() : 'ecg';
            return window.PROJECT_CONFIG && window.PROJECT_CONFIG[proj] ? window.PROJECT_CONFIG[proj] : null;
        }

        function renderStepsAccordion() {
            const cfg = getConfig();
            const container = document.getElementById('steps-accordion-container');
            if (!container || !cfg || !cfg.stages) return;
            const includeInRunAll = window.getStageIncludeInRunAll;
            const overlayLabel = window.getStageOverlayLabel;
            const setInclude = window.setStageIncludeInRunAll;
            const setOverlay = window.setStageOverlayLabel;
            const groups = cfg.stageGroups || {};

            container.innerHTML = cfg.stages.map(s => {
                const sid = s.id;
                const incl = includeInRunAll ? includeInRunAll(sid) : true;
                const overlay = overlayLabel ? overlayLabel(sid) : false;
                const groupName = s.group ? (groups[s.group]?.name || s.group) : null;

                return `
                <div class="step-accordion" data-stage-id="${sid}">
                    <div class="step-accordion-header" onclick="toggleStepAccordion(${sid})">
                        <div class="step-title-wrap">
                            <span class="step-expand-icon">‚ñ∂</span>
                            <span class="step-number">${String(sid).padStart(2,'0')}</span>
                            <span class="step-title">${s.name}</span>
                            ${groupName ? `<span class="step-group-badge">${groupName}</span>` : ''}
                        </div>
                        <div class="step-settings" onclick="event.stopPropagation();">
                            <label class="step-setting-checkbox">
                                <input type="checkbox" ${incl ? 'checked' : ''} onchange="setStageIncludeInRunAll(${sid}, this.checked)">
                                Include in Run All
                            </label>
                            <label class="step-setting-checkbox">
                                <input type="checkbox" ${overlay ? 'checked' : ''} onchange="setStageOverlayLabel(${sid}, this.checked)">
                                Overlay stage label on output image
                            </label>
                        </div>
                    </div>
                    <div class="step-accordion-body">
                        <div class="step-detail-grid">
                            <div class="step-detail-block">
                                <h4>Input Vector</h4>
                                <div class="vector-display step-input-vector" data-stage="${sid}">No input data</div>
                            </div>
                            <div class="step-detail-block">
                                <h4>Output Vector</h4>
                                <div class="vector-display step-output-vector" data-stage="${sid}">No output data</div>
                            </div>
                            <div class="step-detail-block step-output-image-block">
                                <h4>Output Image</h4>
                                <div class="step-output-image-wrap" data-stage="${sid}">
                                    <div class="step-output-image-placeholder">No output image</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStageGroups() {
            const cfg = getConfig();
            const list = document.getElementById('stage-groups-list');
            const section = document.getElementById('settings-stage-groups');
            if (!list || !cfg?.stageGroups) {
                if (section) section.style.display = 'none';
                return;
            }
            if (section) section.style.display = 'block';
            const selected = window.selectedStageGroups || new Set();
            list.innerHTML = Object.entries(cfg.stageGroups).map(([gid, g]) =>
                `<div class="stage-group-checkbox">
                    <input type="checkbox" id="group-${gid}" ${selected.has(gid) ? 'checked' : ''} onchange="toggleStageGroup('${gid}', this.checked)">
                    <label for="group-${gid}">${g.name} (${g.stages.length} stages)</label>
                </div>`
            ).join('');
        }

        function openSettingsModal() {
            renderStageGroups();
            const modal = document.getElementById('settings-modal');
            if (modal) modal.classList.add('open');
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.classList.remove('open');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('dev-sidebar');
            const btn = document.getElementById('sidebar-collapse-btn');
            if (!sidebar || !btn) return;
            const collapsed = sidebar.classList.toggle('collapsed');
            btn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar';
            btn.setAttribute('aria-label', collapsed ? 'Expand sidebar' : 'Collapse sidebar');
        }

        function toggleStageGroup(groupId, isSelected) {
            const s = window.selectedStageGroups || new Set();
            if (isSelected) s.add(groupId); else s.delete(groupId);
            window.selectedStageGroups = s;
            updateStageButtons();
        }

        function toggleStepAccordion(stageId) {
            const el = document.querySelector('.step-accordion[data-stage-id="' + stageId + '"]');
            if (!el) return;
            const expanded = el.classList.contains('expanded');
            document.querySelectorAll('.step-accordion').forEach(a => a.classList.remove('expanded'));
            if (!expanded) el.classList.add('expanded');
        }

        function updateStageButtons() {
            const cfg = getConfig();
            const wrap = document.getElementById('stage-buttons');
            if (!wrap || !cfg?.stages) return;
            wrap.innerHTML = cfg.stages.map(s =>
                `<button class="stage-btn" data-stage="${s.id}" disabled>Stage ${String(s.id).padStart(2,'0')}</button>`
            ).join('');
        }

        function loadImageGroups() {
            const list = document.getElementById('image-groups-list');
            if (!list) return;
            list.innerHTML = '<li class="empty-state" style="padding: 2rem; text-align: center; color: var(--text-secondary);"><div class="empty-state-icon">üìÅ</div><div>No image groups loaded</div><div style="font-size: 0.875rem; margin-top: 0.5rem;">Load manifest for project</div></li>';
        }

        function handleProjectChange(project) {
            if (typeof window.setCurrentProject === 'function') window.setCurrentProject(project);
            console.log('Project changed to:', project);
            renderStepsAccordion();
            updateStageButtons();
            renderStageGroups();
            loadImageGroups();
        }

        function handleStorageChange(usePermanent) {
            if (typeof window.setUsePermanentStorage === 'function') window.setUsePermanentStorage(!!usePermanent);
            const btn = document.getElementById('save-results-btn');
            if (btn) btn.disabled = !usePermanent;
            console.log('Storage mode:', usePermanent ? 'permanent' : 'temp');
        }

        function runAllStages() {
            const sel = typeof window.getSelectedImages === 'function' ? window.getSelectedImages() : null;
            if (!sel || sel.size === 0) {
                alert('Please select at least one image');
                return;
            }
            const cfg = getConfig();
            if (!cfg?.stages) return;
            const toRun = cfg.stages.filter(s => window.getStageIncludeInRunAll && window.getStageIncludeInRunAll(s.id));
            console.log('Run All: stages', toRun.map(s => s.id), 'overlay flags:', toRun.map(s => ({ id: s.id, overlay: window.getStageOverlayLabel && window.getStageOverlayLabel(s.id) })));
            // TODO: call backend; pass overlay flags per stage
        }

        function saveResults() {
            const usePerm = typeof window.getUsePermanentStorage === 'function' ? window.getUsePermanentStorage() : false;
            if (!usePerm) {
                alert('Please enable "Save to permanent storage" first');
                return;
            }
            console.log('Saving results to permanent storage');
            // TODO: Implement save
        }

        window.toggleStepAccordion = toggleStepAccordion;
        window.toggleStageGroup = toggleStageGroup;
        window.openSettingsModal = openSettingsModal;
        window.closeSettingsModal = closeSettingsModal;
        window.toggleSidebar = toggleSidebar;

        document.addEventListener('DOMContentLoaded', function() {
            updateStageButtons();
            loadImageGroups();
            renderStepsAccordion();
            renderStageGroups();
        });
    </script>
</body>
</html>
