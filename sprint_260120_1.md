# Sprint 1 - January 26, 2026

## Sprint Goal
Complete frontend integration for fit analysis and implement polynomial warp transformation to achieve 80% feature completion.

---

## âœ… COMPLETED ITEMS (Pre-Sprint)

### 1. Backend Services Deployed âœ…

**What was done:**
- Python Cloud Run service deployed and live
- Firebase Cloud Functions deployed (all 11 functions)
- Multi-method transformation endpoint working
- Fit analysis endpoint (`/analyze-fit`) deployed

**How to verify:**
```bash
# 1. Check Python service is live
curl https://ecg-multi-method-101881880910.us-central1.run.app/health

# Expected response:
# {"status":"healthy","multi_method_available":true,"endpoints":["/transform-multi","/analyze-fit","/health"]}

# 2. Check Firebase Functions
firebase functions:list

# Should show processMultiMethodTransform and others

# 3. Test fit analysis endpoint (in Cloud Shell or local)
curl -X POST https://ecg-multi-method-101881880910.us-central1.run.app/analyze-fit \
  -H "Content-Type: application/json" \
  -d '{
    "horizontal_lines": [[[0,50],[10,50.5],[20,51.2]]],
    "vertical_lines": [[[50,0],[50.5,10],[51.2,20]]],
    "max_order": 6
  }'

# Should return JSON with fit options
```

**Status:** âœ… **VERIFIED** - Service URL: `https://ecg-multi-method-101881880910.us-central1.run.app`

---

### 2. Polynomial Fit Analysis System âœ…

**What was done:**
- `polynomial_fitter.py` - Core fitting logic (orders 1-8)
- `fit_analyzer.py` - Aggregates results for UI menu
- RÂ², RMSE, MAE, deviation histogram calculations
- Extrema classification (none/single/multiple)
- Fit recommendations

**How to verify:**
```bash
# 1. Check files exist
ls functions_python/transformers/polynomial_fitter.py
ls functions_python/transformers/fit_analyzer.py

# 2. Test locally (optional)
cd functions_python
python -c "from transformers.fit_analyzer import FitAnalyzer; print('Import successful')"

# 3. Check code is in GitHub
git log --oneline --grep="polynomial fit"
# Should show commit with fit analysis
```

**Files:**
- âœ… `functions_python/transformers/polynomial_fitter.py` (458 lines)
- âœ… `functions_python/transformers/fit_analyzer.py` (396 lines)
- âœ… `functions_python/main.py` (has `/analyze-fit` endpoint)

**Status:** âœ… **VERIFIED** - Code committed and deployed

---

### 3. Barrel Transformer âœ…

**What was done:**
- Full barrel distortion correction implemented
- Grid detection working
- Image transformation working
- Quality metrics calculated

**How to verify:**
```bash
# 1. Check file exists and has transform method
grep -n "def transform" functions_python/transformers/barrel_transformer.py

# 2. Check it's imported in multi_method_processor
grep "BarrelTransformer" functions_python/transformers/multi_method_processor.py

# 3. Test in gallery UI:
# - Go to gallery
# - Click on image
# - Click "Process All Methods"
# - Should see barrel transformation result
```

**Status:** âœ… **VERIFIED** - Working in production

---

### 4. Multi-Method Processor âœ…

**What was done:**
- Framework for running all methods
- Ranking system
- Best method selection

**How to verify:**
```bash
# Check file exists
ls functions_python/transformers/multi_method_processor.py

# Check it's used in main.py
grep "MultiMethodProcessor" functions_python/main.py
```

**Status:** âœ… **VERIFIED** - Integrated and working

---

## ðŸŽ¯ SPRINT TASKS

### Task 1: Frontend Fit Analysis UI ðŸ”´ **CRITICAL**

**Priority:** P0 (Critical)  
**Estimated Time:** 2-3 hours  
**Assignee:** [Your Name]

#### Acceptance Criteria:
- [ ] "Analyze Fit" button appears after grid detection
- [ ] Button calls Firebase Function â†’ Python `/analyze-fit` endpoint
- [ ] Fit menu displays in right sidebar with all polynomial orders
- [ ] Each fit option shows:
  - [ ] Order name (e.g., "Linear", "Quadratic")
  - [ ] Formula (e.g., "y = mx + b")
  - [ ] RÂ² value (horizontal and vertical)
  - [ ] Combined RÂ²
  - [ ] Average deviation in pixels
  - [ ] Deviation histogram (perfect, <0.5px, 0.5-1px, etc.)
  - [ ] Extrema type (none/single/multiple)
  - [ ] Recommendation badge (â­ if recommended)
- [ ] Menu is scrollable if many options
- [ ] Loading state shown while analyzing
- [ ] Error handling if analysis fails

#### Implementation Steps:

1. **Add Analyze Fit Button** (30 min)
   - File: `public/gallery.html`
   - Location: After "Detect & Transform" button in transform section
   - Function: `analyzeFit()`

2. **Create Firebase Function Call** (30 min)
   - Add function to call `processMultiMethodTransform` with grid line data
   - Or create new function `analyzeFit` in `functions/index.js`
   - Pass detected grid lines to Python service

3. **Create Fit Menu UI Component** (1 hour)
   - Right sidebar panel
   - Display fit options in cards/list
   - Show metrics for each order
   - Highlight recommended option

4. **Add Styling** (30 min)
   - Match existing gallery UI style
   - Responsive design
   - Color coding for quality

#### How to Verify:
```bash
# 1. Open gallery in browser
# 2. Click on an image
# 3. Click "Detect & Transform" (or grid detection)
# 4. Click "Analyze Fit" button
# 5. Verify:
#    - Button appears
#    - Loading indicator shows
#    - Fit menu appears in right sidebar
#    - All polynomial orders (1-8) are listed
#    - Metrics are displayed correctly
#    - Recommended option is highlighted
```

#### Test Cases:
- [ ] Test with perfectly straight grid (should recommend linear)
- [ ] Test with barrel distortion (should recommend quadratic)
- [ ] Test with wavy distortion (should recommend higher order)
- [ ] Test error handling (no grid detected)
- [ ] Test with different image sizes

---

### Task 2: Polynomial Order Selection UI ðŸ”´ **CRITICAL**

**Priority:** P0 (Critical)  
**Estimated Time:** 1-2 hours  
**Assignee:** [Your Name]

#### Acceptance Criteria:
- [ ] User can select a polynomial order from fit menu
- [ ] Selected order is visually highlighted
- [ ] "Apply Selected Fit" button appears when order is selected
- [ ] Selection is stored in state
- [ ] Can change selection

#### Implementation Steps:

1. **Add Selection Mechanism** (30 min)
   - Radio buttons or clickable cards
   - Visual feedback on selection
   - Store selected order in variable

2. **Add Apply Button** (30 min)
   - Only enabled when order selected
   - Calls transformation with selected order
   - Shows loading state

3. **State Management** (30 min)
   - Track selected order
   - Track fit analysis results
   - Update UI based on state

#### How to Verify:
```bash
# 1. Complete Task 1 first
# 2. In fit menu, click on a fit option
# 3. Verify:
#    - Option is highlighted/selected
#    - "Apply Selected Fit" button appears/enables
#    - Can change selection
#    - Selection persists
```

---

### Task 3: Implement Polynomial Warp Transformation ðŸ”´ **CRITICAL**

**Priority:** P0 (Critical)  
**Estimated Time:** 4-6 hours  
**Assignee:** [Your Name]

#### Acceptance Criteria:
- [ ] `apply_transformation()` method fully implemented
- [ ] No placeholder code (`return image`)
- [ ] Polynomial coefficients applied to image
- [ ] Dense coordinate mapping created
- [ ] Inverse mapping used (remap)
- [ ] Interpolation applied correctly
- [ ] Transformed image returned
- [ ] Quality metrics calculated on transformed image

#### Implementation Steps:

1. **Create Coordinate Grid** (1 hour)
   ```python
   # In apply_transformation method
   h, w = image.shape[:2]
   y_coords, x_coords = np.mgrid[0:h, 0:w]
   ```

2. **Apply Polynomial Transformations** (2 hours)
   - Use polynomial coefficients from `params`
   - Transform horizontal lines: `y = f(x)`
   - Transform vertical lines: `x = f(y)`
   - Create mapping arrays

3. **Implement Remap** (1 hour)
   ```python
   map_x = ...  # Transformed x coordinates
   map_y = ...  # Transformed y coordinates
   transformed = cv2.remap(image, map_x, map_y, cv2.INTER_LINEAR)
   ```

4. **Handle Edge Cases** (1 hour)
   - Out of bounds coordinates
   - Invalid polynomial coefficients
   - Empty params

5. **Test with Sample Images** (1 hour)
   - Test with barrel distortion
   - Test with straight lines
   - Verify quality metrics

#### File to Edit:
- `functions_python/transformers/polynomial_transformer.py`
- Line 148: Replace placeholder with actual implementation

#### How to Verify:
```bash
# 1. Check placeholder is removed
grep -n "return image  # Placeholder" functions_python/transformers/polynomial_transformer.py
# Should return nothing (placeholder removed)

# 2. Check implementation exists
grep -A 20 "def apply_transformation" functions_python/transformers/polynomial_transformer.py
# Should show actual implementation, not just "return image"

# 3. Test locally (optional)
cd functions_python
python -c "
from transformers.polynomial_transformer import PolynomialTransformer
import numpy as np
transformer = PolynomialTransformer()
# Test with sample image
"

# 4. Test in gallery:
# - Select polynomial order
# - Click "Apply Selected Fit"
# - Verify transformed image appears
# - Verify it's different from original
```

#### Test Cases:
- [ ] Test with order 1 (linear) - should be minimal change if lines are straight
- [ ] Test with order 2 (quadratic) - should correct barrel distortion
- [ ] Test with order 3+ - should handle complex curves
- [ ] Test with invalid coefficients - should handle gracefully
- [ ] Test with different image sizes
- [ ] Verify quality metrics are calculated

---

### Task 4: Connect UI to Backend Transformation ðŸ”´ **CRITICAL**

**Priority:** P0 (Critical)  
**Estimated Time:** 2-3 hours  
**Assignee:** [Your Name]

#### Acceptance Criteria:
- [ ] Selected polynomial order sent to backend
- [ ] Backend applies transformation with selected order
- [ ] Transformed image returned and displayed
- [ ] Before/after comparison shown
- [ ] Quality metrics displayed
- [ ] Error handling for failed transformations

#### Implementation Steps:

1. **Update Firebase Function** (1 hour)
   - Modify `processMultiMethodTransform` to accept `selected_order` parameter
   - Pass order to Python service
   - Or create new function `applyPolynomialTransform`

2. **Update Python Endpoint** (30 min)
   - Modify `/transform-multi` to accept `polynomial_order` parameter
   - Use specified order instead of trying all

3. **Update Frontend** (1 hour)
   - Send selected order when clicking "Apply Selected Fit"
   - Display transformed result
   - Show comparison view
   - Display quality metrics

4. **Error Handling** (30 min)
   - Handle transformation failures
   - Show user-friendly error messages
   - Fallback to original image

#### How to Verify:
```bash
# 1. Complete Tasks 1-3 first
# 2. In gallery:
#    - Detect grid
#    - Analyze fit
#    - Select polynomial order (e.g., order 2)
#    - Click "Apply Selected Fit"
# 3. Verify:
#    - Loading indicator shows
#    - Transformed image appears
#    - Image is different from original
#    - Quality metrics are displayed
#    - No errors in console
```

#### Test Cases:
- [ ] Test with each polynomial order (1-8)
- [ ] Test with invalid order - should handle gracefully
- [ ] Test network error - should show error message
- [ ] Test timeout - should handle gracefully
- [ ] Verify transformed image quality

---

## ðŸ“‹ SPRINT CHECKLIST

### Pre-Sprint Verification âœ…
- [x] Backend services deployed
- [x] Fit analysis code written
- [x] Barrel transformer working
- [x] Multi-method processor working

### Sprint Tasks
- [ ] **Task 1:** Frontend Fit Analysis UI (2-3 hours)
- [ ] **Task 2:** Polynomial Order Selection UI (1-2 hours)
- [ ] **Task 3:** Implement Polynomial Warp (4-6 hours)
- [ ] **Task 4:** Connect UI to Backend (2-3 hours)

### Testing
- [ ] Test fit analysis with various images
- [ ] Test polynomial warp with different orders
- [ ] Test error handling
- [ ] Test UI responsiveness
- [ ] Test on different browsers

### Documentation
- [ ] Update `SPRINT_STATUS.md` with completed tasks
- [ ] Document any new functions/endpoints
- [ ] Update `COMPLETION_CHECKLIST.md`

---

## ðŸŽ¯ Sprint Goals

**Primary Goal:** Complete frontend integration and polynomial warp to achieve 80% feature completion.

**Success Criteria:**
1. âœ… User can analyze grid line fits
2. âœ… User can see all polynomial order options
3. âœ… User can select a polynomial order
4. âœ… User can apply selected transformation
5. âœ… Transformed image is displayed correctly
6. âœ… Quality metrics are shown

---

## ðŸ“Š Progress Tracking

### Week 1 (Jan 26 - Feb 1)
- [ ] Task 1: Frontend Fit Analysis UI
- [ ] Task 2: Polynomial Order Selection UI
- [ ] Task 3: Implement Polynomial Warp (start)

### Week 2 (Feb 2 - Feb 8)
- [ ] Task 3: Implement Polynomial Warp (complete)
- [ ] Task 4: Connect UI to Backend
- [ ] Testing and bug fixes

---

## ðŸ› Known Issues / Blockers

### Current Blockers:
- None identified

### Potential Issues:
- CORS issues when calling Python service directly (use Firebase Function proxy)
- Large images may timeout (increase timeout in Cloud Run)
- Polynomial warp may be slow for high orders (optimize algorithm)

---

## ðŸ“ Notes

### Dependencies:
- Task 2 depends on Task 1
- Task 4 depends on Tasks 1, 2, and 3
- Task 3 can be done in parallel with Tasks 1-2

### Estimated Total Time:
- **Minimum:** 9 hours (if everything goes smoothly)
- **Realistic:** 12-15 hours (with testing and debugging)
- **Maximum:** 20 hours (if major issues arise)

### Sprint Duration:
- **Target:** 1-2 weeks
- **Start Date:** January 26, 2026
- **End Date:** February 8, 2026

---

## âœ… Definition of Done

A task is considered complete when:
1. âœ… Code is written and tested
2. âœ… All acceptance criteria met
3. âœ… No console errors
4. âœ… Works in browser
5. âœ… Code committed to GitHub
6. âœ… Documentation updated (if needed)

---

## ðŸš€ Quick Start

1. **Verify pre-sprint items** (see above)
2. **Start with Task 1** (Frontend Fit Analysis UI)
3. **Test as you go** (don't wait until the end)
4. **Commit frequently** (small, working commits)
5. **Update this doc** (check off items as you complete them)

---

## ðŸ“ž Questions / Help

If you get stuck:
1. Check `COMPLETION_CHECKLIST.md` for detailed implementation notes
2. Review `FIT_ANALYSIS_GUIDE.md` for fit analysis details
3. Check existing code in `functions_python/transformers/` for examples
4. Test with simple cases first, then complex ones

---

**Last Updated:** January 20, 2026  
**Sprint Start:** January 26, 2026  
**Sprint End:** February 8, 2026
